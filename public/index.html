<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Панель авторизации</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
            background-color: #000;
            color: #fff;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #auth-page-container,
        #error-page-container,
        #main-app-container {
            width: 100%;
            max-width: 1200px;
            box-sizing: border-box;
            flex-grow: 1;
        }

        #auth-page-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            text-align: center;
            background-color: #000;
            color: #fff;
            padding: 20px;
            box-sizing: border-box;
        }
        #auth-page-content h2 {
            font-size: 2em;
            margin-bottom: 20px;
        }
        #auth-page-content form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 400px;
        }
        #auth-page-content input {
            padding: 10px;
            font-size: 1em;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #222;
            color: #fff;
        }
        #auth-page-content button {
            background-color: #007bff;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
        }
        #auth-page-content button:hover {
            background-color: #0056b3;
        }
        #auth-page-content .error-message {
            color: #dc3545;
            font-size: 0.9em;
            margin-top: 10px;
        }

        #error-page-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 40px);
            text-align: center;
            background-color: #000;
            color: #fff;
        }
        #error-page-content .error-code {
            font-size: 8em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        #error-page-content .error-message {
            font-size: 2em;
            margin-bottom: 30px;
        }
        #error-page-content .link.invisible-link {
            color: inherit;
            text-decoration: none;
            cursor: pointer;
        }
        #error-page-content .link.invisible-link:hover {
            text-decoration: none;
            color: inherit;
        }
        #error-page-content .request-id {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #aaa;
        }
        #error-page-content .info-text {
            font-size: 1em;
            margin-bottom: 10px;
        }
        #error-page-content .info-text .link {
            color: #007bff;
            text-decoration: none;
        }
        #error-page-content .info-text .link:hover {
            text-decoration: underline;
        }
        #error-page-content .powered-by {
            margin-top: 20px;
            font-size: 0.9em;
            color: #777;
        }

        #main-app-content {
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        #main-app-content .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        #main-app-content .header-container h1 {
            margin: 0;
            flex-grow: 1;
            text-align: center;
        }
        #main-app-content button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
        }
        #main-app-content button:hover {
            background-color: #0056b3;
        }

        .dashboard-stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .stat-card {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
            flex: 1;
            min-width: 150px;
        }
        .stat-card h3 {
            margin: 0;
            font-size: 1.1em;
            color: #555;
        }
        .stat-card .stat-value {
            font-size: 2.2em;
            font-weight: bold;
            margin-top: 5px;
            color: #007bff;
        }

        .controls-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            padding: 10px 0;
        }
        .controls-container label {
            font-weight: bold;
        }
        .controls-container select, .controls-container button {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background-color: #fff;
        }

        #user-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .user-card {
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
        }
        .user-card.unanswered {
            border: 2px solid #dc3545;
        }
        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }
        .user-card h3 {
            font-size: 1.2em;
            margin-top: 0;
            margin-bottom: 10px;
            color: #4a69bd;
            word-break: break-all;
        }
        .user-card .screenshot-count {
            font-size: 0.9em;
            color: #666;
            font-weight: bold;
        }
        .user-card .status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #28a745;
            box-shadow: 0 0 5px rgba(40, 167, 69, 0.5);
        }
        .user-card.unanswered .status-indicator {
            background-color: #dc3545;
            box-shadow: 0 0 5px rgba(220, 53, 69, 0.5);
        }

        .no-users-message {
            text-align: center;
            grid-column: 1 / -1;
            font-size: 1.2em;
            color: #777;
            padding: 50px;
        }

        #full-screen-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            flex-direction: column;
            padding: 0; /* Изменение: Убрали padding для использования всей ширины */
            box-sizing: border-box;
            overflow-y: auto;
        }

        #modal-header {
            width: 100%;
            max-width: 90vw;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
            box-sizing: border-box;
            position: sticky;
            top: 0;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 101;
        }

        #modal-header #modal-close-button {
            position: static;
            margin-bottom: 0;
        }

        #modal-header #screenshot-counter {
            color: white;
            font-size: 1.1em;
            font-weight: bold;
        }

        #modal-screenshots-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 1400px; /* Изменение: Увеличили максимальную ширину */
            margin: 0 auto;
            padding-bottom: 20px;
            box-sizing: border-box;
            align-items: center;
        }

        .screenshot-item {
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            box-sizing: border-box;
            width: 100%;
        }
        .screenshot-item.unanswered-item {
            border: 2px solid #dc3545;
        }

        .screenshot-item h3 {
            font-size: 1.2em;
            margin-top: 0;
            margin-bottom: 15px;
            color: #4a69bd;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 10px;
            width: 100%;
            text-align: left;
            flex-shrink: 0;
        }
        .screenshot-item .image-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 150px;
        }

        .screenshot-item img {
            max-width: 100%;
            max-height: 700px; /* Изменение: Увеличили максимальную высоту */
            width: auto;
            height: auto;
            display: block;
            margin: 0 auto;
            border: 1px solid #f5f5f5;
            border-radius: 5px;
            object-fit: contain;
            background-color: #fff;
            flex-shrink: 0;
        }

        .screenshot-item .answer-display {
            margin-top: 15px;
            padding: 12px;
            background-color: #e9f5ff;
            border-left: 4px solid #007bff;
            font-size: 0.95em;
            color: #333;
            border-radius: 5px;
            min-height: 3em;
            display: flex;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
            flex-shrink: 0;
        }
        .screenshot-item .answer-display.unanswered-text {
            background-color: #fff3f4;
            border-left-color: #dc3545;
            color: #555;
            font-style: italic;
        }
        .screenshot-item textarea {
            margin-top: 15px;
            min-height: 60px;
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
            flex-shrink: 0;
        }
        .screenshot-item .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            width: 100%;
            flex-shrink: 0;
        }
        .screenshot-item .action-buttons button {
            flex: 1;
            padding: 12px;
            font-size: 1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .screenshot-item .action-buttons button:hover {
            transform: translateY(-2px);
        }
        .screenshot-item .submit-button {
            background-color: #28a745;
            color: white;
        }
        .screenshot-item .submit-button:hover {
            background-color: #218838;
        }
        .screenshot-item .delete-button {
            background-color: #dc3545;
            color: white;
        }
        .screenshot-item .delete-button:hover {
            background-color: #c82333;
        }
        .screenshot-item .reset-button {
            background-color: #6c757d;
            color: white;
        }
        .screenshot-item .reset-button:hover {
            background-color: #5a6268;
        }
        .no-screenshots-message {
            text-align: center;
            font-size: 1.2em;
            color: #777;
            padding: 50px;
        }
        .no-screenshots-for-user {
            text-align: center;
            width: 100%;
            font-size: 1.2em;
            color: #ccc;
            padding: 50px;
        }

        @media (max-width: 768px) {
            #user-cards-container {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            #modal-screenshots-container {
                gap: 15px;
            }
            .screenshot-item img {
                max-height: 400px; /* Изменение: Увеличили максимальную высоту для мобильных устройств */
            }
            .screenshot-item .action-buttons button {
                padding: 10px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div id="auth-page-container">
        <div id="auth-page-content">
            <h2 id="auth-title">Тебя ждут....</h2>
            <form id="auth-form">
                <input type="text" id="username" placeholder="Имя пользователя (например, admin1)" required>
                <input type="password" id="password" placeholder="Пароль (например, adminXA)" required>
                <button type="submit" id="auth-submit">Войти</button>
                <div class="error-message" id="auth-error"></div>
            </form>
        </div>
    </div>

    <div id="error-page-container">
        <div id="error-page-content">
            <div class="error-code">502</div>
            <div class="error-message">
                <a href="#" class="link invisible-link" id="bad-gateway-link">Bad</a> Gateway
            </div>
            <div class="request-id">Request ID: 95fb249e39e5c6d9-PDX</div>
            <div class="info-text">Этот сервис в настоящее время недоступен. Пожалуйста, попробуйте снова через несколько минут.</div>
            <div class="info-text">Если вы являетесь владельцем сайта, обратитесь к <a href="https://render.com/docs" class="link">документации Render</a> для устранения неполадок.</div>
            <div class="powered-by">Powered by Render</div>
        </div>
    </div>

    <div id="main-app-container">
        <div id="main-app-content">
            <div class="header-container">
                <h1>Терпение, главный ключ ко всем дверям....</h1>
            </div>
            <div class="dashboard-stats">
                <div class="stat-card">
                    <h3>Активных пользователей</h3>
                    <div class="stat-value" id="total-users">0</div>
                </div>
                <div class="stat-card">
                    <h3>Неотвеченных</h3>
                    <div class="stat-value" id="unanswered-count">0</div>
                </div>
                <div class="stat-card">
                    <h3>Всего запросов</h3>
                    <div class="stat-value" id="total-screenshots">0</div>
                </div>
            </div>
            <div class="controls-container">
                <label for="filter-select">Фильтр:</label>
                <select id="filter-select">
                    <option value="all">Все</option>
                    <option value="unanswered">Неотвеченные</option>
                    <option value="answered">Отвеченные</option>
                </select>
                <label for="sort-select">Сортировка:</label>
                <select id="sort-select">
                    <option value="newest">Новые</option>
                    <option value="oldest">Старые</option>
                </select>
                <button id="refresh-users">Обновить</button>
            </div>
            <div id="user-cards-container">
                <p class="no-users-message" id="no-users-message">Ожидание пользователей...</p>
            </div>
        </div>
    </div>

    <div id="full-screen-modal">
        <div id="modal-header">
            <button id="modal-close-button">Закрыть</button>
            <span id="screenshot-counter"></span>
        </div>
        <div id="modal-screenshots-container">
        </div>
    </div>

    <script>
        const authPageContainer = document.getElementById('auth-page-container');
        const errorPageContainer = document.getElementById('error-page-container');
        const mainAppContainer = document.getElementById('main-app-container');
        const authForm = document.getElementById('auth-form');
        const authError = document.getElementById('auth-error');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const badGatewayLink = document.getElementById('bad-gateway-link');
        const pageTitle = document.getElementById('page-title');

        const userCardsContainer = document.getElementById('user-cards-container');
        const noUsersMessage = document.getElementById('no-users-message');
        const refreshUsersButton = document.getElementById('refresh-users');
        const fullScreenModal = document.getElementById('full-screen-modal');
        const modalCloseButton = document.getElementById('modal-close-button');
        const modalScreenshotsContainer = document.getElementById('modal-screenshots-container');
        const screenshotCounter = document.getElementById('screenshot-counter');

        const totalUsersStat = document.getElementById('total-users');
        const unansweredCountStat = document.getElementById('unanswered-count');
        const totalScreenshotsStat = document.getElementById('total-screenshots');
        const filterSelect = document.getElementById('filter-select');
        const sortSelect = document.getElementById('sort-select');

        let ws;
        let authToken = null;
        let adminId = null;
        let currentOpenHelperId = null;
        let users = new Map();

        function showPage(pageName) {
            authPageContainer.style.display = 'none';
            errorPageContainer.style.display = 'none';
            mainAppContainer.style.display = 'none';
            fullScreenModal.style.display = 'none';

            if (pageName === 'auth') {
                authPageContainer.style.display = 'flex';
                document.body.style.backgroundColor = '#000';
                document.body.style.color = '#fff';
                pageTitle.textContent = 'Вход для администратора';
            } else if (pageName === 'error') {
                errorPageContainer.style.display = 'flex';
                document.body.style.backgroundColor = '#000';
                document.body.style.color = '#fff';
                pageTitle.textContent = '502 Bad Gateway';
            } else if (pageName === 'main_app') {
                mainAppContainer.style.display = 'block';
                document.body.style.backgroundColor = '#f0f2f5';
                document.body.style.color = '#333';
                pageTitle.textContent = 'Админ панель';
                if (!ws || ws.readyState === WebSocket.CLOSED) {
                    initWebSocket();
                }
                checkNoUsers();
            }
        }

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authError.textContent = '';
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!username || !password) {
                authError.textContent = 'Требуются имя пользователя и пароль';
                return;
            }

            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    showPage('main_app');
                } else {
                    authError.textContent = data.message || 'Ошибка входа. Проверьте имя пользователя и пароль.';
                }
            } catch (err) {
                authError.textContent = 'Ошибка сервера. Попробуйте позже.';
                console.error('Admin: Ошибка авторизации:', err);
            }
        });

        badGatewayLink.addEventListener('click', (event) => {
            event.preventDefault();
            showPage('auth');
        });

        function initWebSocket() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${location.host}`;
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('Admin: WebSocket подключен');
                ws.send(JSON.stringify({ type: 'admin_connect', role: 'admin' }));
            };

            ws.onmessage = (event) => {
                let data;
                try {
                    data = JSON.parse(event.data);
                    console.log('Admin: Получено сообщение:', data);
                } catch (err) {
                    console.error('Admin: Ошибка разбора сообщения:', err);
                    return;
                }

                if (data.type === 'all_screenshots') {
                    users.clear();
                    data.screenshots.forEach(ss => {
                        let user = users.get(ss.helperId);
                        if (!user) {
                            user = {
                                helperId: ss.helperId,
                                clientId: ss.clientId,
                                screenshots: [],
                                timestamp: parseInt(ss.questionId.split('-')[1]) || Date.now()
                            };
                            users.set(ss.helperId, user);
                        }
                        user.screenshots.push({
                            questionId: ss.questionId,
                            imageUrl: ss.imageUrl,
                            answer: ss.answer
                        });
                    });
                    adminId = data.adminId;
                    renderUserCards();
                    updateStats();
                } else if (data.type === 'new_screenshot') {
                    let user = users.get(data.helperId);
                    if (!user) {
                        user = {
                            helperId: data.helperId,
                            clientId: data.clientId,
                            screenshots: [],
                            timestamp: parseInt(data.questionId.split('-')[1]) || Date.now()
                        };
                        users.set(data.helperId, user);
                    }
                    user.screenshots.push({
                        questionId: data.questionId,
                        imageUrl: data.imageUrl,
                        answer: ''
                    });
                    renderUserCards();
                    updateStats();
                } else if (data.type === 'update_screenshot') {
                    const user = Array.from(users.values()).find(u => u.screenshots.some(s => s.questionId === data.questionId));
                    if (user) {
                        const screenshot = user.screenshots.find(s => s.questionId === data.questionId);
                        if (screenshot) {
                            screenshot.answer = data.answer;
                            if (currentOpenHelperId === user.helperId) {
                                openScreenshotsModal(user.helperId);
                            }
                            renderUserCards();
                            updateStats();
                        }
                    }
                } else if (data.type === 'screenshot_deleted') {
                    const user = Array.from(users.values()).find(u => u.screenshots.some(s => s.questionId === data.questionId));
                    if (user) {
                        user.screenshots = user.screenshots.filter(s => s.questionId !== data.questionId);
                        if (user.screenshots.length === 0) {
                            users.delete(user.helperId);
                        }
                        renderUserCards();
                        updateStats();
                        if (currentOpenHelperId === data.helperId) {
                            if (users.has(data.helperId)) {
                                openScreenshotsModal(data.helperId);
                            } else {
                                closeScreenshotsModal();
                            }
                        }
                    }
                } else if (data.type === 'helper_deleted') {
                    users.delete(data.helperId);
                    renderUserCards();
                    updateStats();
                    if (currentOpenHelperId === data.helperId) {
                        closeScreenshotsModal();
                    }
                } else if (data.type === 'error') {
                    console.error('Admin: Ошибка сервера:', data.message);
                    alert(data.message);
                }
            };

            ws.onclose = () => {
                console.log('Admin: WebSocket отключен. Переподключение через 2 секунды...');
                setTimeout(initWebSocket, 2000);
            };

            ws.onerror = (error) => {
                console.error('Admin: Ошибка WebSocket:', error);
                showPage('error');
            };
        }

        function renderUserCards() {
            userCardsContainer.innerHTML = '';
            let filteredUsers = Array.from(users.values());

            const filterValue = filterSelect.value;
            if (filterValue === 'unanswered') {
                filteredUsers = filteredUsers.filter(user => user.screenshots.some(s => !s.answer));
            } else if (filterValue === 'answered') {
                filteredUsers = filteredUsers.filter(user => user.screenshots.every(s => s.answer));
            }

            const sortValue = sortSelect.value;
            if (sortValue === 'newest') {
                filteredUsers.sort((a, b) => b.timestamp - a.timestamp);
            } else if (sortValue === 'oldest') {
                filteredUsers.sort((a, b) => a.timestamp - b.timestamp);
            }

            if (filteredUsers.length === 0) {
                noUsersMessage.style.display = 'block';
                noUsersMessage.textContent = 'Нет пользователей, соответствующих фильтрам.';
            } else {
                noUsersMessage.style.display = 'none';
                filteredUsers.forEach(user => {
                    const card = document.createElement('div');
                    card.className = 'user-card';
                    card.dataset.helperId = user.helperId;

                    const unansweredScreenshots = user.screenshots.filter(s => !s.answer).length;
                    if (unansweredScreenshots > 0) {
                        card.classList.add('unanswered');
                    }
                    card.addEventListener('click', () => openScreenshotsModal(user.helperId));

                    const h3 = document.createElement('h3');
                    h3.textContent = `Пользователь: ${user.helperId}`;
                    card.appendChild(h3);

                    const countDiv = document.createElement('div');
                    countDiv.className = 'screenshot-count';
                    countDiv.textContent = `Скриншотов: ${user.screenshots.length}`;
                    card.appendChild(countDiv);

                    if (unansweredScreenshots > 0) {
                        const statusIndicator = document.createElement('div');
                        statusIndicator.className = 'status-indicator';
                        statusIndicator.title = 'Есть неотвеченные запросы';
                        card.appendChild(statusIndicator);
                    }

                    userCardsContainer.appendChild(card);
                });
            }
        }

        function updateStats() {
            const totalUnanswered = Array.from(users.values()).reduce((count, user) => {
                return count + user.screenshots.filter(s => !s.answer).length;
            }, 0);
            const totalScreenshots = Array.from(users.values()).reduce((count, user) => {
                return count + user.screenshots.length;
            }, 0);

            totalUsersStat.textContent = users.size;
            unansweredCountStat.textContent = totalUnanswered;
            totalScreenshotsStat.textContent = totalScreenshots;
            checkNoUsers();
        }

        function checkNoUsers() {
            const filterValue = filterSelect.value;
            const hasUsers = Array.from(users.values()).some(user => {
                if (filterValue === 'all') return true;
                if (filterValue === 'unanswered') return user.screenshots.some(s => !s.answer);
                if (filterValue === 'answered') return user.screenshots.every(s => s.answer);
            });

            if (users.size === 0) {
                noUsersMessage.textContent = 'Ожидание пользователей...';
                noUsersMessage.style.display = 'block';
            } else if (!hasUsers) {
                noUsersMessage.textContent = 'Нет пользователей, соответствующих фильтрам.';
                noUsersMessage.style.display = 'block';
            } else {
                noUsersMessage.style.display = 'none';
            }
        }

        function openScreenshotsModal(helperId) {
            currentOpenHelperId = helperId;
            const user = users.get(helperId);
            if (!user) {
                console.error('Admin: Пользователь не найден:', helperId);
                return;
            }

            modalScreenshotsContainer.innerHTML = '';
            fullScreenModal.style.display = 'flex';

            user.screenshots.forEach(screenshot => {
                const item = document.createElement('div');
                item.className = 'screenshot-item';
                item.dataset.questionId = screenshot.questionId;

                if (!screenshot.answer) {
                    item.classList.add('unanswered-item');
                }

                const title = document.createElement('h3');
                title.textContent = `Запрос от ${user.helperId}`;
                item.appendChild(title);

                const imageWrapper = document.createElement('div');
                imageWrapper.className = 'image-wrapper';
                const img = document.createElement('img');
                img.src = screenshot.imageUrl;
                img.alt = 'Скриншот запроса';
                imageWrapper.appendChild(img);
                item.appendChild(imageWrapper);

                const answerDisplay = document.createElement('div');
                answerDisplay.className = 'answer-display';
                if (screenshot.answer) {
                    answerDisplay.textContent = screenshot.answer;
                } else {
                    answerDisplay.textContent = 'Ответ пока не предоставлен.';
                    answerDisplay.classList.add('unanswered-text');
                }
                item.appendChild(answerDisplay);

                const textarea = document.createElement('textarea');
                textarea.placeholder = 'Напишите ваш ответ...';
                item.appendChild(textarea);

                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'action-buttons';
                const submitButton = document.createElement('button');
                submitButton.textContent = 'Ответить';
                submitButton.className = 'submit-button';
                submitButton.addEventListener('click', () => submitAnswer(screenshot.questionId, textarea.value));
                buttonsDiv.appendChild(submitButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Удалить';
                deleteButton.className = 'delete-button';
                deleteButton.addEventListener('click', () => deleteScreenshot(screenshot.questionId));
                buttonsDiv.appendChild(deleteButton);
                
                const resetButton = document.createElement('button');
                resetButton.textContent = 'Сбросить ответ';
                resetButton.className = 'reset-button';
                resetButton.addEventListener('click', () => resetAnswer(screenshot.questionId));
                buttonsDiv.appendChild(resetButton);

                item.appendChild(buttonsDiv);
                modalScreenshotsContainer.appendChild(item);
            });

            if (user.screenshots.length === 0) {
                const noScreenshotsMessage = document.createElement('p');
                noScreenshotsMessage.className = 'no-screenshots-for-user';
                noScreenshotsMessage.textContent = 'У этого пользователя нет скриншотов.';
                modalScreenshotsContainer.appendChild(noScreenshotsMessage);
            }
            
            updateScreenshotCounter(user.screenshots.length);
        }

        function closeScreenshotsModal() {
            fullScreenModal.style.display = 'none';
            currentOpenHelperId = null;
        }

        modalCloseButton.addEventListener('click', closeScreenshotsModal);

        function submitAnswer(questionId, answer) {
            if (!answer.trim()) {
                alert('Ответ не может быть пустым.');
                return;
            }
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'answer_screenshot',
                    questionId: questionId,
                    answer: answer,
                    token: authToken
                }));
            } else {
                console.error('Admin: WebSocket не подключен. Ответ не отправлен.');
                alert('Не удалось отправить ответ. WebSocket не подключен.');
            }
        }

        function deleteScreenshot(questionId) {
            if (confirm('Вы уверены, что хотите удалить этот скриншот?')) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'delete_screenshot',
                        questionId: questionId,
                        token: authToken
                    }));
                } else {
                    console.error('Admin: WebSocket не подключен. Скриншот не удален.');
                    alert('Не удалось удалить скриншот. WebSocket не подключен.');
                }
            }
        }
        
        function resetAnswer(questionId) {
            if (confirm('Вы уверены, что хотите сбросить ответ для этого скриншота?')) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'answer_screenshot',
                        questionId: questionId,
                        answer: '',
                        token: authToken
                    }));
                } else {
                    console.error('Admin: WebSocket не подключен. Ответ не сброшен.');
                    alert('Не удалось сбросить ответ. WebSocket не подключен.');
                }
            }
        }

        function updateScreenshotCounter(count) {
            screenshotCounter.textContent = `Всего скриншотов: ${count}`;
        }

        refreshUsersButton.addEventListener('click', () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'get_all_screenshots', token: authToken }));
            } else {
                console.error('Admin: WebSocket не подключен. Не удалось обновить данные.');
            }
        });

        filterSelect.addEventListener('change', renderUserCards);
        sortSelect.addEventListener('change', renderUserCards);

        // Инициализация при загрузке страницы
        window.onload = () => {
            showPage('auth');
        };
    </script>
</body>
</html>
